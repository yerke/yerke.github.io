<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>A main interface - The Embedonomicon</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body class="light">
        <!-- Provide site root to javascript -->
        <script type="text/javascript">var path_to_root = "";</script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { } 
            if (theme === null || theme === undefined) { theme = 'light'; }
            document.body.className = theme;
            document.querySelector('html').className = theme + ' js';
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <ol class="chapter"><li class="affix"><a href="preface.html">Preface</a></li><li><a href="smallest-no-std.html"><strong aria-hidden="true">1.</strong> The smallest #![no_std] program</a></li><li><a href="memory-layout.html"><strong aria-hidden="true">2.</strong> Memory layout</a></li><li><a href="main.html" class="active"><strong aria-hidden="true">3.</strong> A main interface</a></li><li><a href="exceptions.html"><strong aria-hidden="true">4.</strong> Exception handling</a></li><li><a href="asm.html"><strong aria-hidden="true">5.</strong> Assembly on stable</a></li><li><a href="logging.html"><strong aria-hidden="true">6.</strong> Logging with symbols</a></li><li><a href="singleton.html"><strong aria-hidden="true">7.</strong> Global singletons</a></li><li><a href="dma.html"><strong aria-hidden="true">8.</strong> DMA</a></li><li class="spacer"></li><li class="affix"><a href="compiler-support.html">A note on compiler support</a></li></ol>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                                <li role="none"><button role="menuitem" class="theme" id="light">Light <span class="default">(default)</span></button></li>
                                <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            </ul>
                            
                            <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                            
                        </div>

                        <h1 class="menu-title">The Embedonomicon</h1> 

                        <div class="right-buttons">
                            <a href="print.html" title="Print this book" aria-label="Print this book">
                                <i id="print-button" class="fa fa-print"></i>
                            </a>
                        </div>
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <a class="header" href="#a-main-interface" id="a-main-interface"><h1>A <code>main</code> interface</h1></a>
<p>We have a minimal working program now, but we need to package it in a way that the end user can build
safe programs on top of it. In this section, we'll implement a <code>main</code> interface like the one standard
Rust programs use.</p>
<p>First, we'll convert our binary crate into a library crate:</p>
<pre><code class="language-console">$ mv src/main.rs src/lib.rs
</code></pre>
<p>And then rename it to <code>rt</code> which stands for &quot;runtime&quot;.</p>
<pre><code class="language-console">$ sed -i s/app/rt/ Cargo.toml

$ head -n4 Cargo.toml
</code></pre>
<pre><code class="language-toml">[package]
edition = &quot;2018&quot;
name = &quot;rt&quot; # &lt;-
version = &quot;0.1.0&quot;
</code></pre>
<p>The first change is to have the reset handler call an external <code>main</code> function:</p>
<pre><code class="language-console">$ head -n13 src/lib.rs
</code></pre>
<pre><pre class="playpen"><code class="language-rust">#![no_std]

use core::panic::PanicInfo;

// CHANGED!
#[no_mangle]
pub unsafe extern &quot;C&quot; fn Reset() -&gt; ! {
    extern &quot;Rust&quot; {
        fn main() -&gt; !;
    }

    main()
}
</code></pre></pre>
<p>We also drop the <code>#![no_main]</code> attribute as it has no effect on library crates.</p>
<blockquote>
<p>There's an orthogonal question that arises at this stage: Should the <code>rt</code>
library provide a standard panicking behavior, or should it <em>not</em> provide a
<code>#[panic_handler]</code> function and leave the end user choose the panicking
behavior? This document won't delve into that question and for simplicity will
leave the dummy <code>#[panic_handler]</code> function in the <code>rt</code> crate. However, we
wanted to inform the reader that there are other options.</p>
</blockquote>
<p>The second change involves providing the linker script we wrote before to the application crate. You
see the linker will search for linker scripts in the library search path (<code>-L</code>) and in the directory
from which it's invoked. The application crate shouldn't need to carry around a copy of <code>link.x</code> so
we'll have the <code>rt</code> crate put the linker script in the library search path using a <a href="https://doc.rust-lang.org/cargo/reference/build-scripts.html">build script</a>.</p>
<pre><code class="language-console">$ # create a build.rs file in the root of `rt` with these contents
$ cat build.rs
</code></pre>
<pre><pre class="playpen"><code class="language-rust">use std::{env, error::Error, fs::File, io::Write, path::PathBuf};

fn main() -&gt; Result&lt;(), Box&lt;dyn Error&gt;&gt; {
    // build directory for this crate
    let out_dir = PathBuf::from(env::var_os(&quot;OUT_DIR&quot;).unwrap());

    // extend the library search path
    println!(&quot;cargo:rustc-link-search={}&quot;, out_dir.display());

    // put `link.x` in the build directory
    File::create(out_dir.join(&quot;link.x&quot;))?.write_all(include_bytes!(&quot;link.x&quot;))?;

    Ok(())
}

</code></pre></pre>
<p>Now the user can write an application that exposes the <code>main</code> symbol and link it to the <code>rt</code> crate.
The <code>rt</code> will take care of giving the program the right memory layout.</p>
<pre><code class="language-console">$ cd ..

$ cargo new --edition 2018 --bin app

$ cd app

$ # modify Cargo.toml to include the `rt` crate as a dependency
$ tail -n2 Cargo.toml
</code></pre>
<pre><code class="language-toml">[dependencies]
rt = { path = &quot;../rt&quot; }
</code></pre>
<pre><code class="language-console">$ # copy over the config file that sets a default target and tweaks the linker invocation
$ cp -r ../rt/.cargo .

$ # change the contents of `main.rs` to
$ cat src/main.rs
</code></pre>
<pre><pre class="playpen"><code class="language-rust">#![no_std]
#![no_main]

extern crate rt;

#[no_mangle]
pub fn main() -&gt; ! {
    let _x = 42;

    loop {}
}

</code></pre></pre>
<p>The disassembly will be similar but will now include the user <code>main</code> function.</p>
<pre><code class="language-console">$ cargo objdump --bin app -- -d -no-show-raw-insn
</code></pre>
<pre><code class="language-text">
app:	file format ELF32-arm-little


Disassembly of section .text:

main:
                sub	sp, #4
                movs	r0, #42
                str	r0, [sp]
                b	#-2 &lt;main+0x8&gt;
                b	#-4 &lt;main+0x8&gt;

Reset:
                bl	#-14
                trap

</code></pre>
<a class="header" href="#making-it-type-safe" id="making-it-type-safe"><h2>Making it type safe</h2></a>
<p>The <code>main</code> interface works, but it's easy to get it wrong: For example, the user could write <code>main</code>
as a non-divergent function, and they would get no compile time error and undefined behavior (the
compiler will misoptimize the program).</p>
<p>We can add type safety by exposing a macro to the user instead of the symbol interface. In the
<code>rt</code> crate, we can write this macro:</p>
<pre><code class="language-console">$ tail -n12 ../rt/src/lib.rs
</code></pre>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
#[macro_export]
macro_rules! entry {
    ($path:path) =&gt; {
        #[export_name = &quot;main&quot;]
        pub unsafe fn __main() -&gt; ! {
            // type check the given path
            let f: fn() -&gt; ! = $path;

            f()
        }
    }
}
#}</code></pre></pre>
<p>Then the application writers can invoke it like this:</p>
<pre><code class="language-console">$ cat src/main.rs
</code></pre>
<pre><pre class="playpen"><code class="language-rust">#![no_std]
#![no_main]

use rt::entry;

entry!(main);

fn main() -&gt; ! {
    let _x = 42;

    loop {}
}

</code></pre></pre>
<p>Now the author will get an error if they change the signature of <code>main</code> to be
non divergent function, e.g. <code>fn()</code>.</p>
<a class="header" href="#life-before-main" id="life-before-main"><h2>Life before main</h2></a>
<p><code>rt</code> is looking good but it's not feature complete! Applications written against it can't use
<code>static</code> variables or string literals because <code>rt</code>'s linker script doesn't define the standard
<code>.bss</code>, <code>.data</code> and <code>.rodata</code> sections. Let's fix that!</p>
<p>The first step is to define these sections in the linker script:</p>
<pre><code class="language-console">$ # showing just a fragment of the file
$ sed -n 25,46p ../rt/link.x
</code></pre>
<pre><code class="language-text">  .text :
  {
    *(.text .text.*);
  } &gt; FLASH

  /* NEW! */
  .rodata :
  {
    *(.rodata .rodata.*);
  } &gt; FLASH

  .bss :
  {
    *(.bss .bss.*);
  } &gt; RAM

  .data :
  {
    *(.data .data.*);
  } &gt; RAM

  /DISCARD/ :
</code></pre>
<p>They just re-export the input sections and specify in which memory region each output section will
go.</p>
<p>With these changes, the following program will compile:</p>
<pre><pre class="playpen"><code class="language-rust">#![no_std]
#![no_main]

use rt::entry;

entry!(main);

static RODATA: &amp;[u8] = b&quot;Hello, world!&quot;;
static mut BSS: u8 = 0;
static mut DATA: u16 = 1;

fn main() -&gt; ! {
    let _x = RODATA;
    let _y = unsafe { &amp;BSS };
    let _z = unsafe { &amp;DATA };

    loop {}
}

</code></pre></pre>
<p>However if you run this program on real hardware and debug it, you'll observe that the <code>static</code>
variables <code>BSS</code> and <code>DATA</code> don't have the values <code>0</code> and <code>1</code> by the time <code>main</code> has been reached.
Instead, these variables will have junk values. The problem is that the contents of RAM are
random after powering up the device. You won't be able to observe this effect if you run the
program in QEMU.</p>
<p>As things stand if your program reads any <code>static</code> variable before performing a write to it then
your program has undefined behavior. Let's fix that by initializing all <code>static</code> variables before
calling <code>main</code>.</p>
<p>We'll need to tweak the linker script a bit more to do the RAM initialization:</p>
<pre><code class="language-console">$ # showing just a fragment of the file
$ sed -n 25,52p ../rt/link.x
</code></pre>
<pre><code class="language-text">  .text :
  {
    *(.text .text.*);
  } &gt; FLASH

  /* CHANGED! */
  .rodata :
  {
    *(.rodata .rodata.*);
  } &gt; FLASH

  .bss :
  {
    _sbss = .;
    *(.bss .bss.*);
    _ebss = .;
  } &gt; RAM

  .data : AT(ADDR(.rodata) + SIZEOF(.rodata))
  {
    _sdata = .;
    *(.data .data.*);
    _edata = .;
  } &gt; RAM

  _sidata = LOADADDR(.data);

  /DISCARD/ :
</code></pre>
<p>Let's go into the details of these changes:</p>
<pre><code class="language-text">    _sbss = .;
</code></pre>
<pre><code class="language-text">    _ebss = .;
</code></pre>
<pre><code class="language-text">    _sdata = .;
</code></pre>
<pre><code class="language-text">    _edata = .;
</code></pre>
<p>We associate symbols to the start and end addresses of the <code>.bss</code> and <code>.data</code> sections, which we'll
later use from Rust code.</p>
<pre><code class="language-text">  .data : AT(ADDR(.rodata) + SIZEOF(.rodata))
</code></pre>
<p>We set the Load Memory Address (LMA) of the <code>.data</code> section to the end of the <code>.rodata</code>
section. The <code>.data</code> contains <code>static</code> variables with a non-zero initial value; the Virtual Memory
Address (VMA) of the <code>.data</code> section is somewhere in RAM -- this is where the <code>static</code> variables are
located. The initial values of those <code>static</code> variables, however, must be allocated in non volatile
memory (Flash); the LMA is where in Flash those initial values are stored.</p>
<pre><code class="language-text">  _sidata = LOADADDR(.data);
</code></pre>
<p>Finally, we associate a symbol to the LMA of <code>.data</code>.</p>
<p>On the Rust side, we zero the <code>.bss</code> section and initialize the <code>.data</code> section. We can reference
the symbols we created in the linker script from the Rust code. The <em>addresses</em><sup class="footnote-reference"><a href="#1">1</a></sup> of these symbols are
the boundaries of the <code>.bss</code> and <code>.data</code> sections.</p>
<p>The updated reset handler is shown below:</p>
<pre><code class="language-console">$ head -n32 ../rt/src/lib.rs
</code></pre>
<pre><pre class="playpen"><code class="language-rust">#![no_std]

use core::panic::PanicInfo;
use core::ptr;

#[no_mangle]
pub unsafe extern &quot;C&quot; fn Reset() -&gt; ! {
    // NEW!
    // Initialize RAM
    extern &quot;C&quot; {
        static mut _sbss: u8;
        static mut _ebss: u8;

        static mut _sdata: u8;
        static mut _edata: u8;
        static _sidata: u8;
    }

    let count = &amp;_ebss as *const u8 as usize - &amp;_sbss as *const u8 as usize;
    ptr::write_bytes(&amp;mut _sbss as *mut u8, 0, count);

    let count = &amp;_edata as *const u8 as usize - &amp;_sdata as *const u8 as usize;
    ptr::copy_nonoverlapping(&amp;_sidata as *const u8, &amp;mut _sdata as *mut u8, count);

    // Call user entry point
    extern &quot;Rust&quot; {
        fn main() -&gt; !;
    }

    main()
}
</code></pre></pre>
<p>Now end users can directly and indirectly make use of <code>static</code> variables without running into
undefined behavior!</p>
<blockquote>
<p>In the code above we performed the memory initialization in a bytewise fashion. It's possible to
force the <code>.bss</code> and <code>.data</code> sections to be aligned to, say, 4 bytes. This fact can then be used
in the Rust code to perform the initialization wordwise while omitting alignment checks. If you
are interested in learning how this can be achieved check the <a href="https://github.com/japaric/cortex-m-rt/tree/v0.5.1"><code>cortex-m-rt</code></a> crate.</p>
</blockquote>
<div class="footnote-definition" id="1"><sup class="footnote-definition-label">1</sup>
<p>The fact that the addresses of the linker script symbols must be used here can be confusing and
unintuitive. An elaborate explanation for this oddity can be found <a href="https://stackoverflow.com/a/40392131">here</a>.</p>
</div>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="memory-layout.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="exceptions.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a href="memory-layout.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a href="exceptions.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
